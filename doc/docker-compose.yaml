name: jc_club

networks:
  backend:
    driver: bridge

volumes:
  mysql_data:
  nacos_logs:
  redis_data:
  xxl-job_logs:
  es_data:
  es_logs:
  minio_data:
  jenkins_data:
  rmq_broker_logs:
  rmq_broker_store:
  rmq_dashboard_temp:

services:
  mysql:
    image: 'bitnami/mysql:8.4.3'
    container_name: mysql
    mem_limit: 256m
    environment:
      TZ: Asia/Shanghai # 设置时区
      MYSQL_ROOT_PASSWORD: Wyj199751
    restart: always
    ports:
      - "3306:3306"
    volumes:
      # 指定的 mysql_data volume 之前不存在，则会执行 /docker-entrypoint-initdb.d/ 目录下的sql
      - ./sql/:/docker-entrypoint-initdb.d/
      # 只要是创建容器都会执行 /docker-entrypoint-startdb.d/ 目录下的sql
      # - ./sql/:/docker-entrypoint-startdb.d
      - mysql_data:/bitnami/mysql/data
    networks:
      - backend

  nacos:
    image: nacos/nacos-server:v2.4.3
    container_name: nacos
    mem_limit: 512m
    restart: always
    ports:
      # web 界面访问端口
      - 8848:8848
      # 程序使用 grpc 连接的端口
      - 9848:9848
    environment:
      - MODE=standalone
      - JVM_XMS=128m
      - JVM_XMX=128m
      - JVM_XMN=128m
    volumes:
      - nacos_logs:/home/nacos/logs
    networks:
      - backend

  redis:
    image: bitnami/redis:7.4.2
    container_name: redis # 容器名称
    mem_limit: 256m
    restart: always # 重启方式
    environment:
      - TZ=Asia/Shanghai # 设置时区
      - REDIS_PASSWORD=Wyj199751
      - REDIS_DISABLE_COMMANDS=FLUSHDB,FLUSHALL
    ports:
      - '6379:6379'
    volumes:
      - redis_data:/bitnami/redis/data
    networks:
      - backend

  xxl-job-admin:
    image: xuxueli/xxl-job-admin:2.3.0
    container_name: xxl-job-admin # 容器名称
    mem_limit: 256m
    restart: always
    volumes:
      - xxl-job_logs:/data/applogs
    ports:
      - "8800:8800"
    environment:
      PARAMS: '
        --server.port=8800
        --server.servlet.context-path=/xxl-job-admin
        --spring.datasource.url=jdbc:mysql://mysql:3306/xxl_job?useUnicode=true&characterEncoding=UTF-8&autoReconnect=true&serverTimezone=Asia/Shanghai
        --spring.datasource.username=root
        --spring.datasource.password=Wyj199751
        --xxl.job.accessToken=Wyj199751'  #代码里面需要指定的token
      JAVA_OPTS: "-Xms128m -Xmx128m"
    networks:
      - backend
    depends_on:
      - mysql

  namesrv:
    image: apache/rocketmq:5.3.0
    container_name: rmq-namesrv
    mem_limit: 256m
    restart: always
    ports:
      - "9876:9876"
    networks:
      - backend
    environment:
      - JAVA_OPTS=-Xms128m -Xmx128m
    command: sh mqnamesrv

  broker:
    image: apache/rocketmq:5.3.0
    container_name: rmq-broker
    mem_limit: 512m
    restart: always
    ports:
      - "10909:10909"
      - "10911:10911"
      - "10912:10912"
    environment:
      NAMESRV_ADDR: "namesrv:9876"
      # 设置jvm内存大小，使用JAVA_OPTS配置不会生效
      JAVA_OPT_EXT: "-server -Xms128m -Xmx128m -Xmn128m"
    depends_on:
      - namesrv
    volumes:
      - ./data/rocketmq/broker/conf/broker.conf:/home/rocketmq/conf/broker.conf
#      - rmq_broker_logs:/home/rocketmq/logs
#      - rmq_broker_store:/home/rocketmq/store
    networks:
      - backend
    command: sh mqbroker -c /home/rocketmq/conf/broker.conf

  dashboard:
    image: apacherocketmq/rocketmq-dashboard:latest
    container_name: rmq-dashboard
    mem_limit: 256m
    restart: always
    ports:
      - "8082:8082"
    environment:
      JAVA_OPTS: "-Xms128m -Xmx128m -Drocketmq.namesrv.addr=namesrv:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false"
    depends_on:
      - namesrv
    volumes:
      - rmq_dashboard_temp:/tmp
    networks:
      - backend

  elasticsearch:
    image: bitnami/elasticsearch:7.5.2
    container_name: elasticsearch
    mem_limit: 512m
    restart: always
    volumes:
      #      - ./es/etc/localtime:/etc/localtime
      - ./data/es/plugins:/opt/bitnami/elasticsearch/plugins #插件文件挂载
      - es_data:/bitnami/elasticsearch/data #数据文件挂载
      - es_logs:/opt/bitnami/elasticsearch/logs
    privileged: true
    ports:
      - '9200:9200'
      - '9300:9300'
    environment:
      - cluster.name=jc-club
      - node.name=jc-club-node
      - ES_JAVA_OPTS=-Xms128m -Xmx128m #设置使用jvm内存大小
      - DB_BASE_DIR=/bitnami/elasticsearch
    networks:
      - backend

  minio:
    image: bitnami/minio:2024.12.18
    container_name: minio
    mem_limit: 256m
    restart: always
    ports:
      - '9000:9000'
      - '9001:9001'
    environment:
      - MINIO_ROOT_USER=root
      - MINIO_ROOT_PASSWORD=Wyj199751
    volumes:
      - minio_data:/bitnami/minio/data
    networks:
      - backend

  jenkins:
    image: jenkins/jenkins:2.493
    container_name: jenkins
    mem_limit: 256m
    restart: always
    volumes: # 挂载目录  本地文件夹目录:容器文件夹目录
      - jenkins_data:/var/jenkins_home
    #     - /var/run/docker.sock:/var/run/docker.sock
    #     - /usr/bin/docker:/usr/bin/docker
    #     - /usr/lib/x86_64-linux-gnu/libltdl.so.7:/usr/lib/x86_64-linux-gnu/libltdl.so.7
    ports: # 绑定端口
      - "9898:8080"
    expose: # 暴露端口
      - "8080"
      - "50000"
    privileged: true
    user: root
    environment:
      JAVA_OPTS: '-Xms128m -Xmx128m -Djava.util.logging.config.file=/var/jenkins_home/log.properties'
      JENKINS_ADMIN_ID: root
      JENKINS_ADMIN_PASSWORD: Wyj199751
    networks:
      - backend
  frpc:
    restart: always
    mem_limit: 256m
    network_mode: host
    volumes:
      - './data/frpc/frpc.toml:/etc/frp/frpc.toml'
    container_name: frpc
    image: snowdreamtech/frpc